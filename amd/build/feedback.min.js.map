{"version":3,"file":"feedback.min.js","sources":["../src/feedback.js"],"sourcesContent":["// File path: amd/src/feedbackmodule.js\ndefine(['jquery', 'core/ajax', 'local_edwiserreports/select2'], function ($, Ajax) {\n\n    const SELECTOR = {\n        PANEL: '#feedbackmod',\n        TABLEAREA: '.tablearea',\n        COURSE: '.course-select',\n        MODULE: '.feedback-select',\n        COHORT: '.user-select',\n        MODULENAME: '#feedbackname'\n    };\n\n    let filter = {\n        course: 0,\n        cohort: 0,\n        dir: $('html').attr('dir'),\n        profilefield: ''\n    };\n\n    /**\n     * Get course feedback chart data.\n     */\n    function getCourseFeedback() {\n        return Ajax.call([{\n            methodname: 'local_dashboardv2_get_feedbacks',\n            args: {\n                profilefield: filter.profilefield,\n                courseid: filter.course,\n                username: filter.cohort,\n                moduleid: filter.group ?? 0,\n            }\n        }])[0];\n    }\n\n    /**\n     *  Get table name.\n     */\n    function fn_get_table_names() {\n        $(SELECTOR.MODULE).empty();\n        getCourseFeedback().then((response) => {\n            response.feedbacks.forEach(function (cl) {\n                $(SELECTOR.MODULE).append($(\"<option></option>\")\n                    .attr(\"value\", cl.id)\n                    .text(cl.name + '(' + cl.section + ')')\n                    .attr(\"title\", cl.section)\n                    .attr(\"data-cmid\", cl.cmid)\n                );\n            });\n            if (filter.group !== undefined && filter.group !== 0) {\n                $(`${SELECTOR.PANEL} ${SELECTOR.MODULE}`).val(filter.group);\n            } else {\n                $(`${SELECTOR.PANEL} ${SELECTOR.MODULE}`).val(response.feedbacks[0].id);\n            }\n\n            filter.group = $(`${SELECTOR.PANEL} ${SELECTOR.MODULE}`).val();\n\n            if (response.report.length === 0) {\n                $(SELECTOR.TABLEAREA).html('<div class=\"alert alert-dark m-5\">The feedback has not been published yet.</div>');\n                $(\".fp-btn\").attr(\"href\", \"\").css({ 'pointer-events': 'none', 'opacity': 0.3 });\n                $(`${SELECTOR.PANEL} ${SELECTOR.MODULENAME}`).html(\"\");\n                return;\n            }\n\n            loadTableData(response.report, response.totalusers);\n        });\n    }\n\n    /**\n     * load table data\n     *\n     * @param {any} response\n     * @param {BigInt} totalUsers\n     *\n     * @returns\n     */\n    function loadTableData(response, totalUsers = 0) {\n        if (typeof filter.group === 'undefined') {\n            return;\n        }\n\n        let entry_id = $(`${SELECTOR.PANEL} ${SELECTOR.MODULE}`).find('option:selected')[0].dataset.cmid;\n        let para = '?id=' + entry_id;\n        $(\".fp-btn\").attr(\"href\", M.cfg.wwwroot + \"/mod/feedback/show_entries.php\" + para);\n        $(\".fp-btn\").css({ 'pointer-events': 'auto', 'opacity': 1 });\n\n        $(SELECTOR.PANEL).find(SELECTOR.FORMFILTER).val(JSON.stringify(filter));\n\n        $(SELECTOR.TABLEAREA).html('');\n        generateTable(response);\n        $(`${SELECTOR.PANEL} ${SELECTOR.MODULENAME}`).html(\n            \"Total User: <b>\" + totalUsers + \"</b>\"\n        );\n    }\n\n    /**\n     * Generate Table\n     * @param {any} data\n     */\n    function generateTable(data) {\n        let sForm = '<table class=\"table table-striped table-hover\">';\n        sForm += '<thead class=\"table-light\">';\n        sForm += '<tr>';\n        sForm += '<th>Reason</th><th>Excellent</th><th>Good</th><th>Average</th>';\n        sForm += '<th>Needs Improvement</th><th>Average Rating</th></tr>';\n        sForm += '</thead><tbody>';\n\n        data.forEach(function (cl) {\n            let spanClass = '';\n            if (cl.id !== '9999') {\n                if (cl.final_category === 'Excellent') {\n                    spanClass = 'badge bg-success text-light';\n                } else if (cl.final_category === 'Good') {\n                    spanClass = 'badge bg-info text-light';\n                } else if (cl.final_category === 'Average') {\n                    spanClass = 'badge bg-primary text-light';\n                } else if (cl.final_category === 'Needs Improvement') {\n                    spanClass = 'badge bg-danger text-light';\n                }\n            }\n            const spanWrapper = '<span class=\"' + spanClass + '\">' + cl.final_category + '</span>';\n            sForm += '<tr><td>' + cl.question + '</td>';\n            sForm += '<td class=\"text-center\">' + cl.excellent + '</td>';\n            sForm += '<td class=\"text-center\">' + cl.good + '</td>';\n            sForm += '<td class=\"text-center\">' + cl.average + '</td>';\n            sForm += '<td class=\"text-center\">' + cl.needs_improvement + '</td>';\n            sForm += '<td class=\"text-center\">' + spanWrapper +\n                ' <span class=\"d-block\" style=\"font-size:12px;\">(' + cl.avg_score + ')</span></td></tr>';\n        });\n\n        sForm += '</tbody></table>';\n        $(SELECTOR.TABLEAREA).html(sForm);\n    }\n\n    /**\n     * Public init method\n     */\n    function init() {\n\n        if ($(SELECTOR.COURSE).length === 0) {\n            return;\n        }\n\n\n        $(SELECTOR.PANEL + ' .singleselect').select2();\n\n        $('body').on('change', `${SELECTOR.PANEL} ${SELECTOR.COHORT}`, function () {\n            filter.course = $(`${SELECTOR.PANEL} ${SELECTOR.COURSE}`).val();\n            filter.group = $(`${SELECTOR.PANEL} ${SELECTOR.MODULE}`).val();\n            filter.profilefield = $(this).attr('data-for');\n            filter.cohort = $(this).val();\n            fn_get_table_names();\n        });\n\n        $('body').on('change', `${SELECTOR.PANEL} ${SELECTOR.COURSE}`, function () {\n            filter.course = parseInt($(this).val());\n            filter.cohort = $(`${SELECTOR.PANEL} ${SELECTOR.COHORT}`).val();\n            filter.profilefield = $(`${SELECTOR.PANEL} ${SELECTOR.COHORT}`).attr('data-for');\n            filter.group = 0;\n            fn_get_table_names();\n        });\n\n        $('body').on('change', `${SELECTOR.PANEL} ${SELECTOR.MODULE}`, function () {\n            filter.course = $(`${SELECTOR.PANEL} ${SELECTOR.COURSE}`).val();\n            filter.cohort = $(`${SELECTOR.PANEL} ${SELECTOR.COHORT}`).val();\n            filter.profilefield = $(`${SELECTOR.PANEL} ${SELECTOR.COHORT}`).attr('data-for');\n\n            filter.group = parseInt($(this).val());\n            fn_get_table_names();\n        });\n\n        filter.course = $(`${SELECTOR.PANEL} ${SELECTOR.COURSE}`).val();\n        filter.cohort = $(`${SELECTOR.PANEL} ${SELECTOR.COHORT}`).val();\n        filter.profilefield = $(`${SELECTOR.PANEL} ${SELECTOR.COHORT}`).attr('data-for');\n\n        fn_get_table_names();\n    }\n\n    return {\n        init: init\n    };\n});\n"],"names":["define","$","Ajax","SELECTOR","PANEL","TABLEAREA","COURSE","MODULE","COHORT","MODULENAME","filter","course","cohort","dir","attr","profilefield","fn_get_table_names","empty","call","methodname","args","courseid","username","moduleid","group","then","response","feedbacks","forEach","cl","append","id","text","name","section","cmid","undefined","val","report","length","html","css","totalUsers","para","find","dataset","M","cfg","wwwroot","FORMFILTER","JSON","stringify","generateTable","loadTableData","totalusers","data","sForm","spanClass","final_category","spanWrapper","question","excellent","good","average","needs_improvement","avg_score","init","select2","on","this","parseInt"],"mappings":"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"}