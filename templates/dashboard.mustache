{{!
    Updated template with AJAX support and report links - dashboard.mustache
}}
<div id="dashboard-container">
    <!-- Header -->
    <div class="dashboard-header">
        <h3 class="welcome-text">
            {{#str}}welcome, local_dashboardv2{{/str}}, {{user_fullname}}
            <span class="role-badge">({{role_display}})</span>
        </h3>
       <p><strong>{{#str}}your_region, local_dashboardv2{{/str}}</strong> {{user_region}}</p>
    </div>
    <div class="dashboard-content">
        <div class="row g-4">
        {{#insights}}
            <div class="insight col-12 col-md-6 col-xl-3 mb-5 {{class}}" data-id="{{class}}">
                <div class="insight-wrapper p-3">
                    <div class="row">
                        <div class="col-sm-3 p-0">
                            <div class="insight-image">
                                <img src="{{icon}}" alt="{{class}}" class="img-fluid">
                            </div>
                        </div>
                        <div class="col-sm-9 p-0">
                            <h5 class="insight-title mb-0">{{title}}</h5>
                            <div class="insight-wrap d-flex justify-content-between align-items-center">
                                <label class="insight-value pr-2 theme-primary-text h3" data-oldvalue="1208">{{count}}</label>
                                <a href="{{config.wwwroot}}/local/dashboardv2/reports.php?type={{class}}" 
                                   class="btn btn-sm btn-outline-primary" 
                                   title="View {{title}} Report">
                                    <i class="fa fa-chart-line"></i> {{#str}}report, local_dashboardv2{{/str}}
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {{/insights}}
        </div>
    </div>
   <div class="feedback-section">
    <h4>{{#str}}feedback_analysis, local_dashboardv2{{/str}}</h4>
    <div class="row">
        <div class="col-12 col-md-4">
            <!-- User Hierarchy Selection (existing) -->
            {{#is_spoc}}
                {{#has_area_managers}}
                    <div class="form-group">
                        <label for="selected_area_manager">{{#str}}select_area_manager, local_dashboardv2{{/str}}</label>
                        <select name="selected_area_manager" id="selected_area_manager" class="form-control feedback-filter">
                            <option value="">{{#str}}choose_area_manager, local_dashboardv2{{/str}}</option>
                            {{#area_managers}}
                            <option value="{{username}}" {{#selected}}selected{{/selected}}>
                                {{fullname}} ({{username}})
                            </option>
                            {{/area_managers}}
                        </select>
                    </div>
                {{/has_area_managers}}
            {{/is_spoc}}

            {{#is_area_manager}}
                {{#has_nutrition_officers}}
                    <div class="form-group">
                        <label for="selected_nutrition_officer">{{#str}}select_nutrition_officer, local_dashboardv2{{/str}}</label>
                        <select name="selected_nutrition_officer" id="selected_nutrition_officer" class="form-control feedback-filter">
                            <option value="">{{#str}}choose_nutrition_officer, local_dashboardv2{{/str}}</option>
                            {{#nutrition_officers}}
                            <option value="{{username}}" {{#selected}}selected{{/selected}}>
                                {{fullname}} ({{username}})
                            </option>
                            {{/nutrition_officers}}
                        </select>
                    </div>
                {{/has_nutrition_officers}}
            {{/is_area_manager}}
        </div>

        <div class="col-12 col-md-4">
            <!-- Course Selection -->
            <div class="form-group">
                <label for="selected_course">{{#str}}enrolled_courses, local_dashboardv2{{/str}}</label>
                {{#has_available_courses}}
                    <select name="selected_course" id="selected_course" class="form-control feedback-filter">
                        <option value="">-- Choose a Course --</option>
                        {{#available_courses}}
                        <option value="{{id}}" {{#selected}}selected{{/selected}}>
                            {{fullname}} ({{shortname}})
                        </option>
                        {{/available_courses}}
                    </select>
                {{/has_available_courses}}
                {{^has_available_courses}}
                    <p class="text-muted">No courses available</p>
                {{/has_available_courses}}
            </div>
        </div>

        <div class="col-12 col-md-4">
            <!-- Feedback Form Selection -->
            <div class="form-group">
                <label for="selected_feedback">Feedback Forms</label>
                {{#has_available_feedbacks}}
                    <select name="selected_feedback" id="selected_feedback" class="form-control feedback-filter">
                        <option value="">-- Choose a Feedback Form --</option>
                        {{#available_feedbacks}}
                        <option value="{{id}}" {{#selected}}selected{{/selected}}>
                            {{name}}
                        </option>
                        {{/available_feedbacks}}
                    </select>
                {{/has_available_feedbacks}}
                {{^has_available_feedbacks}}
                    <p class="text-muted">Select a course to see available feedback forms</p>
                {{/has_available_feedbacks}}
            </div>
        </div>
    </div>

    <!-- Feedback Analysis Results -->
    {{#has_feedback_analysis}}
    <div class="feedback-results mt-4">
        <div class="card">
            <div class="card-header">
                <h5>Feedback Analysis Results</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>{{#str}}question, local_dashboardv2{{/str}}</th>
                                <th>{{#str}}excellent, local_dashboardv2{{/str}}</th>
                                <th>{{#str}}good, local_dashboardv2{{/str}}</th>
                                <th>Average</th>
                                <th>{{#str}}needs_improvement, local_dashboardv2{{/str}}</th>
                                <th>{{#str}}avg_score, local_dashboardv2{{/str}}</th>
                                <th>{{#str}}category, local_dashboardv2{{/str}}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{#feedback_analysis_data}}
                            <tr>
                                <td>{{question}}</td>
                                <td><span class="badge badge-success">{{excellent}}</span></td>
                                <td><span class="badge badge-primary">{{good}}</span></td>
                                <td><span class="badge badge-warning">{{average}}</span></td>
                                <td><span class="badge badge-danger">{{needs_improvement}}</span></td>
                                <td><strong>{{avg_score}}</strong></td>
                                <td>
                                    <span class="badge 
                                        {{#if final_category == 'Excellent'}}badge-success{{/if}}
                                        {{#if final_category == 'Good'}}badge-primary{{/if}}
                                        {{#if final_category == 'Average'}}badge-warning{{/if}}
                                        {{#if final_category == 'Needs Improvement'}}badge-danger{{/if}}
                                    ">{{final_category}}</span>
                                </td>
                            </tr>
                            {{/feedback_analysis_data}}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {{/has_feedback_analysis}}
</div>

    {{#has_access}}
        <div class="dashboard-section">
            <div class="row align-items-center">
                <div class="col-12 col-md-4">
                    {{#is_spoc}}
                        <!-- SPOC Dashboard -->
                            {{#has_area_managers}}
                                <div class="form-group">
                                    <label for="selected_area_manager">{{#str}}select_area_manager, local_dashboardv2{{/str}}</label>
                                    <select name="selected_area_manager" id="selected_area_manager" class="form-control">
                                        <option value="">{{#str}}choose_area_manager, local_dashboardv2{{/str}}</option>
                                        {{#area_managers}}
                                        <option value="{{username}}" {{#selected}}selected{{/selected}}>
                                            {{fullname}} ({{username}})
                                        </option>
                                        {{/area_managers}}
                                    </select>
                                </div>
                            {{/has_area_managers}}
                            
                            {{^has_area_managers}}
                                <div class="no-data">
                                    <p>{{#str}}no_area_managers, local_dashboardv2{{/str}}</p>
                                </div>
                            {{/has_area_managers}}
                    {{/is_spoc}}

                    {{#is_area_manager}}
                        <!-- Area Manager Dashboard -->
                            {{#has_nutrition_officers}}
                                <div class="form-group">
                                    <label for="selected_nutrition_officer">{{#str}}select_nutrition_officer, local_dashboardv2{{/str}}</label>
                                    <select name="selected_nutrition_officer" id="selected_nutrition_officer" class="form-control">
                                        <option value="">{{#str}}choose_nutrition_officer, local_dashboardv2{{/str}}</option>
                                        {{#nutrition_officers}}
                                        <option value="{{username}}" {{#selected}}selected{{/selected}}>
                                            {{fullname}} ({{username}})
                                        </option>
                                        {{/nutrition_officers}}
                                    </select>
                                </div>
                            {{/has_nutrition_officers}}
                            
                            {{^has_nutrition_officers}}
                                <div class="no-data">
                                    <p>{{#str}}no_nutrition_officers, local_dashboardv2{{/str}}</p>
                                </div>
                            {{/has_nutrition_officers}}
                    {{/is_area_manager}}
                </div>
                <div class="col-12 col-md-5 d-flex">
                    <input type="text" id="search-users" class="form-control mr-3" placeholder="{{#str}}search_users, local_dashboardv2{{/str}}" aria-label="{{#str}}search_users, local_dashboardv2{{/str}}">
                </div>
                <div class="col-12 col-md-3">
                    <button id="download-users-table" class="btn btn-primary">{{#str}}download_table, local_dashboardv2{{/str}}</button>
                </div>
            </div>

        <!-- Users Data Table Container (Will be updated via AJAX) -->
        <div class="users-table-container">
            {{#has_users_data}}
                <table class="table table-striped users-data-table table-responsive">
                    <thead>
                        <tr>
                            <th>{{#str}}username, local_dashboardv2{{/str}}</th>
                            <th>{{#str}}fullname, local_dashboardv2{{/str}}</th>
                            <th>{{#str}}email, local_dashboardv2{{/str}}</th>
                            <th>{{#str}}spoc, local_dashboardv2{{/str}}</th>
                            <th>{{#str}}regional_head, local_dashboardv2{{/str}}</th>
                            <th>{{#str}}area_manager, local_dashboardv2{{/str}}</th>
                            <th>{{#str}}nutrition_officer, local_dashboardv2{{/str}}</th>
                            <th>{{#str}}module, local_dashboardv2, 1{{/str}}</th>
                            <th>{{#str}}module, local_dashboardv2, 2{{/str}}</th>
                            <th>{{#str}}module, local_dashboardv2, 3{{/str}}</th>
                            <th>{{#str}}module, local_dashboardv2, 4{{/str}}</th>
                            <th>{{#str}}module, local_dashboardv2, 5{{/str}}</th>
                            <th>{{#str}}module, local_dashboardv2, 6{{/str}}</th>
                            <th>{{#str}}module, local_dashboardv2, 7{{/str}}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{#users_data}}
                        <tr>
                            <td>{{username}}</td>
                            <td>{{fullname}}</td>
                            <td>{{email}}</td>
                            <td>{{spoc}}</td>
                            <td>{{regional_head}}</td>
                            <td>{{area_manager}}</td>
                            <td>{{nutrition_officer}}</td>
                            <td>{{module_1}}%</td>
                            <td>{{module_2}}%</td>
                            <td>{{module_3}}%</td>
                            <td>{{module_4}}%</td>
                            <td>{{module_5}}%</td>
                            <td>{{module_6}}%</td>
                            <td>{{module_7}}%</td>
                        </tr>
                        {{/users_data}}
                    </tbody>
                </table>
            {{/has_users_data}}
            {{^has_users_data}}
                <div class="no-data">
                    <p>No users found.</p>
                </div>
            {{/has_users_data}}
        </div>
        </div>
    {{/has_access}}

    {{^has_access}}
        <!-- Access Denied -->
        <div class="alert alert-danger">
            <h3>ðŸš« {{#str}}access_denied, local_dashboardv2{{/str}}</h3>
            <p>{{#str}}no_permission, local_dashboardv2{{/str}}</p>
            <p><strong>{{#str}}current_role, local_dashboardv2{{/str}}</strong> {{role_display}}</p>
            <p><strong>{{#str}}required_roles, local_dashboardv2{{/str}}</strong> Manager or Area Manager</p>
            <p>{{#str}}contact_admin, local_dashboardv2{{/str}}</p>
        </div>
    {{/has_access}}
</div>