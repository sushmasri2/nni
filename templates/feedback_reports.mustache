{{!
    Feedback Reports template - feedback_reports.mustache
}}
<div id="feedback-reports-container">
    <!-- Header -->
    <div class="reports-header mb-4">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h2 class="mb-2">{{#str}}feedback_reports, local_dashboardv2{{/str}}</h2>
                <p class="text-muted mb-0">
                    {{#str}}welcome, local_dashboardv2{{/str}}, {{user_fullname}} 
                    <span class="role-badge">({{role_display}})</span>
                </p>
                {{#spoc_name}}
                <p class="text-muted mb-0"><strong>{{#str}}your_region, local_dashboardv2{{/str}}</strong> {{spoc_name}}</p>
                {{/spoc_name}}
            </div>
            <div class="col-md-4 text-right">
                <a href="{{dashboard_url}}" class="btn btn-secondary">
                    <i class="fa fa-arrow-left"></i> {{#str}}back_to_dashboard, local_dashboardv2{{/str}}
                </a>
            </div>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="feedback-filters-section mb-4">
        <div class="card">
            <div class="card-body">
                <form method="GET" action="" id="feedback-filters-form">
                    <div class="row">
                        <!-- Area Manager / Nutrition Officer Selection -->
                        <div class="col-md-3">
                            {{#is_spoc}}
                                {{#has_area_managers}}
                                    <div class="form-group">
                                        <label for="area_manager">{{#str}}select_area_manager, local_dashboardv2{{/str}}</label>
                                        <select name="area_manager" id="area_manager" class="form-control">
                                            <option value="">{{#str}}choose_area_manager, local_dashboardv2{{/str}}</option>
                                            {{#area_managers}}
                                            <option value="{{username}}" {{#selected}}selected{{/selected}}>
                                                {{fullname}} ({{username}})
                                            </option>
                                            {{/area_managers}}
                                        </select>
                                    </div>
                                {{/has_area_managers}}
                            {{/is_spoc}}

                            {{#is_area_manager}}
                                {{#has_nutrition_officers}}
                                    <div class="form-group">
                                        <label for="nutrition_officer">{{#str}}select_nutrition_officer, local_dashboardv2{{/str}}</label>
                                        <select name="nutrition_officer" id="nutrition_officer" class="form-control">
                                            <option value="">{{#str}}choose_nutrition_officer, local_dashboardv2{{/str}}</option>
                                            {{#nutrition_officers}}
                                            <option value="{{username}}" {{#selected}}selected{{/selected}}>
                                                {{fullname}} ({{username}})
                                            </option>
                                            {{/nutrition_officers}}
                                        </select>
                                    </div>
                                {{/has_nutrition_officers}}
                            {{/is_area_manager}}
                        </div>

                        <!-- Course Selection -->
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="course">{{#str}}select_course, local_dashboardv2{{/str}}</label>
                                <select name="course" id="course" class="form-control">
                                    <option value="">{{#str}}choose_course, local_dashboardv2{{/str}}</option>
                                    {{#courses}}
                                    <option value="{{id}}" {{#selected}}selected{{/selected}}>
                                        {{fullname}}
                                    </option>
                                    {{/courses}}
                                </select>
                            </div>
                        </div>

                        <!-- Feedback Selection -->
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="feedback">{{#str}}select_feedback, local_dashboardv2{{/str}}</label>
                                <select name="feedback" id="feedback" class="form-control">
                                    <option value="">{{#str}}choose_feedback, local_dashboardv2{{/str}}</option>
                                    {{#feedbacks}}
                                    <option value="{{id}}" {{#selected}}selected{{/selected}}>
                                        {{name}}
                                    </option>
                                    {{/feedbacks}}
                                </select>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="col-md-3">
                            <div class="d-flex align-items-end h-100">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fa fa-search"></i> {{#str}}generate_report, local_dashboardv2{{/str}}
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Report Summary -->
    {{#has_feedback_data}}
    <div class="feedback-summary mb-4">
        <div class="alert alert-info">
            <h5 class="mb-2">{{#str}}feedback_summary, local_dashboardv2{{/str}}</h5>
            <p class="mb-0">
                {{#str}}course, local_dashboardv2{{/str}}: <strong>{{selected_course_name}}</strong> |
                {{#str}}feedback, local_dashboardv2{{/str}}: <strong>{{selected_feedback_name}}</strong>
                {{#selected_area_manager}}
                | {{#str}}area_manager, local_dashboardv2{{/str}}: <strong>{{selected_area_manager}}</strong>
                {{/selected_area_manager}}
                {{#selected_nutrition_officer}}
                | {{#str}}nutrition_officer, local_dashboardv2{{/str}}: <strong>{{selected_nutrition_officer}}</strong>
                {{/selected_nutrition_officer}}
            </p>
        </div>
    </div>
    {{/has_feedback_data}}

    <!-- Feedback Data Table -->
    <div class="feedback-table-container">
        {{#has_feedback_data}}
            <div class="card">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover feedback-data-table mb-0">
                            <thead class="thead-dark">
                                <tr>
                                    <th>#</th>
                                    <th>{{#str}}question, local_dashboardv2{{/str}}</th>
                                    <th class="text-center">{{#str}}excellent, local_dashboardv2{{/str}} (4)</th>
                                    <th class="text-center">{{#str}}good, local_dashboardv2{{/str}} (3)</th>
                                    <th class="text-center">{{#str}}average, local_dashboardv2{{/str}} (2)</th>
                                    <th class="text-center">{{#str}}needs_improvement, local_dashboardv2{{/str}} (1)</th>
                                    <th class="text-center">{{#str}}total_responses, local_dashboardv2{{/str}}</th>
                                    <th class="text-center">{{#str}}avg_score, local_dashboardv2{{/str}}</th>
                                    <th class="text-center">{{#str}}category, local_dashboardv2{{/str}}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{#feedback_data}}
                                <tr>
                                    <td><strong>{{id}}</strong></td>
                                    <td>{{question}}</td>
                                    <td class="text-center">
                                        <span class="badge badge-success">{{excellent}}</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge badge-primary">{{good}}</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge badge-warning">{{average}}</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge badge-danger">{{needs_improvement}}</span>
                                    </td>
                                    <td class="text-center">
                                        <strong>{{total_responses}}</strong>
                                    </td>
                                    <td class="text-center">
                                        <span class="font-weight-bold">{{avg_score}}</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge 
                                            {{#final_category}}
                                                {{#equals final_category "Excellent"}}badge-success{{/equals}}
                                                {{#equals final_category "Good"}}badge-primary{{/equals}}
                                                {{#equals final_category "Average"}}badge-warning{{/equals}}
                                                {{#equals final_category "Needs Improvement"}}badge-danger{{/equals}}
                                            {{/final_category}}
                                        ">{{final_category}}</span>
                                    </td>
                                </tr>
                                {{/feedback_data}}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        {{/has_feedback_data}}
        
        {{^has_feedback_data}}
            <div class="card">
                <div class="card-body text-center">
                    <div class="no-data py-5">
                        <i class="fa fa-comments fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">{{#str}}no_feedback_data, local_dashboardv2{{/str}}</h5>
                        <p class="text-muted">{{#str}}select_filters_message, local_dashboardv2{{/str}}</p>
                    </div>
                </div>
            </div>
        {{/has_feedback_data}}
    </div>
</div>

<script>
// Auto-submit form when selections change
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('feedback-filters-form');
    const selects = form.querySelectorAll('select');
    
    selects.forEach(function(select) {
        select.addEventListener('change', function() {
            // Clear dependent dropdowns
            if (this.name === 'area_manager' || this.name === 'nutrition_officer') {
                const courseSelect = form.querySelector('select[name="course"]');
                const feedbackSelect = form.querySelector('select[name="feedback"]');
                if (courseSelect) courseSelect.value = '';
                if (feedbackSelect) feedbackSelect.value = '';
            }
            if (this.name === 'course') {
                const feedbackSelect = form.querySelector('select[name="feedback"]');
                if (feedbackSelect) feedbackSelect.value = '';
            }
            form.submit();
        });
    });
});
</script>